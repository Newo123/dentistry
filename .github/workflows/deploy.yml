name: Deploy to TimeWeb

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build project
        run: npm run build

      - name: ðŸ”‘ Setup TimeWeb SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÐºÐ»ÑŽÑ‡ TimeWeb (Ð˜ÐœÐ•ÐÐÐž Ð’ Ð¢ÐÐšÐžÐœ Ð¤ÐžÐ ÐœÐÐ¢Ð•!)
          cat > ~/.ssh/id_rsa << 'EOF'
          ${{ secrets.SSH_PRIVATE_KEY }}
          EOF

          chmod 600 ~/.ssh/id_rsa

          # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð´Ð»Ñ TimeWeb
          cat > ~/.ssh/config << EOF
          Host timeweb
            HostName ${{ secrets.SSH_HOST }}
            User ${{ secrets.SSH_USER }}
            IdentityFile ~/.ssh/id_rsa
            Port 22
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ConnectTimeout 30
            ServerAliveInterval 300
            ServerAliveCountMax 2
            TCPKeepAlive yes
          EOF

          chmod 600 ~/.ssh/config

      - name: ðŸš€ Deploy to TimeWeb
        run: |
          echo "ðŸ”„ Deploying to TimeWeb server..."

          # Ð’ÐÐ–ÐÐž: TimeWeb Ñ‡Ð°ÑÑ‚Ð¾ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð¾Ñ‚Ð½Ð¾ÑÐ¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ Ð¾Ñ‚ Ð´Ð¾Ð¼Ð°ÑˆÐ½ÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
          REMOTE_PATH="~/public_html"

          # Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð±Ð¸Ð»Ð´Ð°
          rsync -avz --progress \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.github' \
            -e "ssh -F ~/.ssh/config" \
            ./dist/ \
            timeweb:$REMOTE_PATH/
            
          echo "âœ… Files uploaded to TimeWeb!"

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼
          ssh -F ~/.ssh/config timeweb "ls -la $REMOTE_PATH | head -5"
